# 数据库表结构说明

本文档详细说明了招聘会签到取号系统的完整数据库表结构。

## 表结构概览

### 核心业务表

1. **events** - 活动/招聘会表
2. **sign_ins** - 签到记录表
3. **queues** - 排队记录表

### 系统管理表

4. **users** - 管理员/用户表
5. **system_configs** - 系统配置表
6. **operation_logs** - 操作日志表
7. **sms_logs** - 短信发送记录表

---

## 详细表结构

### 1. events（活动/招聘会表）

存储招聘会活动的基本信息。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| name | varchar(200) | 活动名称 |
| description | text | 活动描述 |
| event_date | date | 活动日期 |
| start_time | time | 开始时间 |
| end_time | time | 结束时间 |
| location | varchar(255) | 活动地点 |
| status | enum | 活动状态：draft-草稿，published-已发布，ongoing-进行中，completed-已完成，cancelled-已取消 |
| max_queue_number | int | 最大排队号数量（0表示不限制） |
| average_process_time | int | 平均处理时间（分钟） |
| is_active | boolean | 是否激活（当前活动） |
| settings | json | 活动设置（JSON格式） |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

**索引：**
- `status`, `is_active`
- `event_date`

---

### 2. sign_ins（签到记录表）

存储用户签到信息。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| event_id | bigint | 活动ID（外键关联events表） |
| name | varchar(100) | 姓名 |
| phone | varchar(20) | 手机号（索引） |
| email | varchar(255) | 邮箱地址 |
| company | varchar(255) | 公司名称 |
| position | varchar(255) | 职位 |
| queue_number | varchar(20) | 排队号码（索引） |
| signed_at | timestamp | 签到时间 |
| ip_address | varchar(45) | IP地址 |
| user_agent | varchar(500) | 用户代理（浏览器信息） |
| device_type | enum | 设备类型：mobile-移动端，pc-PC端，tablet-平板，unknown-未知 |
| remark | text | 备注信息 |
| source | enum | 签到来源：web-网页，api-API接口，admin-后台管理 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

**索引：**
- `phone`
- `queue_number`
- `event_id`

**外键：**
- `event_id` → `events.id`

---

### 3. queues（排队记录表）

存储排队队列信息。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| event_id | bigint | 活动ID（外键关联events表） |
| sign_in_id | bigint | 签到记录ID（外键关联sign_ins表） |
| queue_number | varchar(20) | 排队号码（唯一索引） |
| status | enum | 排队状态：waiting-等待中，processing-处理中，completed-已完成，cancelled-已取消 |
| estimated_wait_time | int | 预计等待时间（分钟） |
| actual_wait_time | int | 实际等待时间（分钟） |
| processed_by | bigint | 处理人员ID（外键关联users表） |
| note | text | 处理备注 |
| started_at | timestamp | 开始处理时间 |
| completed_at | timestamp | 完成时间 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

**索引：**
- `queue_number`（唯一）
- `status`
- `event_id`

**外键：**
- `event_id` → `events.id`
- `sign_in_id` → `sign_ins.id`（级联删除）
- `processed_by` → `users.id`（设置为null）

---

### 4. users（管理员/用户表）

存储系统管理员和工作人员信息。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| name | varchar(100) | 姓名 |
| username | varchar(50) | 用户名（登录账号，唯一） |
| email | varchar(255) | 邮箱地址（唯一） |
| phone | varchar(20) | 手机号 |
| email_verified_at | timestamp | 邮箱验证时间 |
| password | varchar(255) | 密码（加密） |
| role | enum | 角色：admin-管理员，staff-工作人员，viewer-查看者 |
| status | enum | 状态：active-激活，inactive-未激活，banned-已禁用 |
| avatar | varchar(255) | 头像URL |
| remark | text | 备注信息 |
| last_login_at | timestamp | 最后登录时间 |
| last_login_ip | varchar(45) | 最后登录IP |
| remember_token | varchar(100) | 记住我令牌 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

**索引：**
- `username`（唯一）
- `email`（唯一）

---

### 5. system_configs（系统配置表）

存储系统配置信息。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| key | varchar(100) | 配置键名（唯一） |
| name | varchar(100) | 配置名称 |
| value | text | 配置值 |
| type | varchar(50) | 配置类型：string-字符串，integer-整数，boolean-布尔值，json-JSON，text-文本 |
| description | text | 配置说明 |
| group | varchar(50) | 配置分组（如：general-通用，queue-排队，sms-短信等） |
| is_public | boolean | 是否公开（前端可访问） |
| sort_order | int | 排序顺序 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

**索引：**
- `key`（唯一）
- `group`
- `is_public`

---

### 6. operation_logs（操作日志表）

记录系统重要操作日志。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| user_id | bigint | 操作用户ID（外键关联users表，可为空表示系统操作） |
| action | varchar(100) | 操作类型（如：sign_in, get_queue, update_status等） |
| module | varchar(50) | 操作模块（如：queue, sign_in, user等） |
| description | text | 操作描述 |
| ip_address | varchar(45) | IP地址 |
| user_agent | varchar(500) | 用户代理（浏览器信息） |
| request_data | json | 请求数据（JSON格式） |
| response_data | json | 响应数据（JSON格式） |
| status | enum | 操作状态：success-成功，failed-失败，warning-警告 |
| error_message | text | 错误信息（如果操作失败） |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

**索引：**
- `user_id`, `created_at`
- `module`, `action`
- `created_at`

**外键：**
- `user_id` → `users.id`（设置为null）

---

### 7. sms_logs（短信发送记录表）

记录短信发送历史。

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | bigint | 主键ID |
| sign_in_id | bigint | 签到记录ID（外键关联sign_ins表） |
| phone | varchar(20) | 接收短信的手机号 |
| queue_number | varchar(20) | 排队号码 |
| content | text | 短信内容 |
| type | enum | 短信类型：queue_notification-排队通知，reminder-提醒，status_update-状态更新，other-其他 |
| status | enum | 发送状态：pending-待发送，sent-已发送，failed-发送失败，delivered-已送达 |
| provider | varchar(50) | 短信服务提供商（如：twilio） |
| provider_message_id | varchar(100) | 服务商返回的消息ID |
| provider_response | text | 服务商返回的响应（JSON格式） |
| error_message | text | 错误信息（如果发送失败） |
| sent_at | timestamp | 发送时间 |
| delivered_at | timestamp | 送达时间 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

**索引：**
- `sign_in_id`, `created_at`
- `phone`, `status`
- `created_at`

**外键：**
- `sign_in_id` → `sign_ins.id`（设置为null）

---

## 表关系图

```
events (活动)
  ├── sign_ins (签到记录) [event_id]
  │     └── queues (排队记录) [sign_in_id]
  └── queues (排队记录) [event_id]
        └── users (处理人员) [processed_by]

users (管理员)
  ├── operation_logs (操作日志) [user_id]
  └── queues (处理的排队记录) [processed_by]

sign_ins (签到记录)
  └── sms_logs (短信记录) [sign_in_id]
```

---

## 迁移文件列表

1. `2024_01_01_000001_create_sign_ins_table.php` - 创建签到记录表
2. `2024_01_01_000002_create_queues_table.php` - 创建排队记录表
3. `2024_01_01_000003_update_sign_ins_table_add_fields.php` - 完善签到记录表（添加IP、设备类型等）
4. `2024_01_01_000004_update_queues_table_add_fields.php` - 完善排队记录表（添加等待时间、处理人员等）
5. `2024_01_01_000005_create_users_table.php` - 创建管理员表
6. `2024_01_01_000006_create_operation_logs_table.php` - 创建操作日志表
7. `2024_01_01_000007_create_sms_logs_table.php` - 创建短信发送记录表
8. `2024_01_01_000008_create_system_configs_table.php` - 创建系统配置表
9. `2024_01_01_000009_create_events_table.php` - 创建活动表
10. `2024_01_01_000010_add_event_id_to_tables.php` - 为sign_ins和queues表添加event_id字段
11. `2024_01_01_000011_add_foreign_key_processed_by.php` - 为queues表添加processed_by外键约束

---

## 使用说明

### 运行迁移

```bash
cd backend
php artisan migrate
```

### 回滚迁移

```bash
# 回滚最后一次迁移
php artisan migrate:rollback

# 回滚所有迁移
php artisan migrate:reset

# 重新运行所有迁移（会删除所有数据）
php artisan migrate:fresh
```

### 查看迁移状态

```bash
php artisan migrate:status
```

---

## 注意事项

1. **外键约束顺序**：确保在创建外键之前，被引用的表已经存在
2. **数据完整性**：使用外键约束确保数据完整性
3. **索引优化**：已为常用查询字段添加索引，提升查询性能
4. **字段注释**：所有字段都添加了中文注释，便于理解和维护
5. **软删除**：部分表使用 `onDelete('set null')` 避免级联删除导致数据丢失

---

## 后续扩展建议

1. **数据统计表**：可以创建统计表存储每日/每小时的统计数据
2. **通知记录表**：可以扩展通知记录表，支持邮件、站内消息等多种通知方式
3. **权限管理表**：如果需要更细粒度的权限控制，可以添加角色权限表
4. **文件上传表**：如果需要上传文件（如简历），可以添加文件管理表

